(this.Reqs=function(r){function t(r){return"[object String]"===y.call(r)}function n(r){return"[object Array]"===y.call(r)}function e(r){return"[object Object]"===y.call(r)}function i(r){return"[object Function]"===y.call(r)}function o(r,t,n){for(var e in r)r.hasOwnProperty(e)&&t.call(n,r[e],e,r)}function a(r){if(void 0!==this.cb){var t=[],n=[];o(this.reqs.SPI,function(r,n){t.push(n)}),o(this.reqs.CPI,function(r,t){n.push(t)}),this.cb(t,n)}}function c(r,i){var o,c,s,l,u,f,C=this.SPI,h=this,d={conn:i,reqs:this};try{o=JSON.parse(r)}catch(p){return void this.error("Not valid JSON.")}if(!this.validate(o))return void this.error("reqs.parse() Not valid object");if(t(o)&&C.hasOwnProperty(o))s=C[o].call(d),void 0!==s&&s===s&&this.send.call(i,JSON.stringify({CALL:o,ARGS:[s]}));else if(e(o))l=[o];else if(!n(o))return void this.err404("reqs.parse() 404 unknown command: "+o.toString());for(u in l){if(u=l[u],void 0!==u.ARGS&&!n(u.ARGS))return void this.err404('Wrong data type in property "ARGS". Data type is: '+y.call(u.ARGS));if(u.hasOwnProperty("CALL")){if(c=u.CALL,void 0===c||!t(c)||!C.hasOwnProperty(c))return void this.err404("Method not found:"+c);if(void 0!==u.CB&&t(u.CB)&&(d.cb=h.createCBWrapper(u.CB,i)),s=C[c].apply(d,u.ARGS),n(s))return void h.send.call(i,JSON.stringify({CALL:c,ARGS:s}))}else{if(u.hasOwnProperty("CALLBACK")){if(f=u.CALLBACK,t(f)){if(void 0!==u.CB&&t(u.CB)){if(s=h.CB(f,i,u.ARGS,h.createCBWrapper(u.CB,i)),n(s))return void h.send.call(i,JSON.stringify({CALLBACK:u.CB,ARGS:s}));return}return void h.CB(f,i,u.ARGS)}return void this.error("Wrong CALLBACK argument type.")}if(!u.hasOwnProperty("INFO"))return void this.err404('Missing root property "CALL" and "CALLBACK".');void 0!==u.CB&&t(u.CB)&&(d.cb=h.createCBWrapper(u.CB,i),a.call(d,u.INFO))}}}function s(r){return!0}function l(r,t){O.warn("Error 404! Resourse not found. Details: "+r),O.warn(t)}function u(r,t){this.send(t,JSON.stringify({ERROR:{MSG:r}}))}function f(){return this._id===Number.MAX_SAFE_INTEGER&&(this._id=1),this._id++}function C(r){var t=this.cbid;return this.CB[t]=r,t.toString()}function h(r,t){var n=this;return function(){var e,o={CALLBACK:r},a=[],c=arguments[arguments.length-1];for(e in arguments)arguments.hasOwnProperty(e)&&a.push(arguments[e]);i(c)&&(o.CB=n.createCallback(c),a=a.slice(0,-1)),a.length>0&&(o.ARGS=a),n.send.call(t,JSON.stringify(o))}}function d(r,t,n){var e=this;return function(){var t,o={CALL:r},a=[],c=arguments[arguments.length-1];for(t in arguments)arguments.hasOwnProperty(t)&&a.push(arguments[t]);i(c)&&(o.CB=e.createCallback(c),a=a.slice(0,-1)),a.length>0?o.ARGS=a:void 0===o.CB&&(o=r),e.send.call(n,JSON.stringify(o))}}function p(r,t,e){var o,a,c=0;for(o=function(t,o,a,c){var s={CALL:t},a={};i(c)?s.CB=r.createCallback(c):i(o)?s.CB=r.createCallback(o):i(a)&&(s.CB=r.createCallback(a)),n(a)&&(s.ARGS=a),e.call(o,JSON.stringify(s))},a=t.length,c;a>c;c++)o[t[c]]=function(t){return function(){var n,o={CALL:t},a=[],c=arguments[arguments.length-1];for(n in arguments)arguments.hasOwnProperty(n)&&a.push(arguments[n]);i(c)&&(o.CB=r.createCallback(c),a=a.slice(0,-1)),a.length>0?o.ARGS=a:void 0===o.CB&&(o=t),e.call(this,JSON.stringify(o))}}(t[c]);return o}function v(r){r=r||{};var t={SPI:r.SPI||{}},n=r.CPI||[];return t._id=0,t.__defineGetter__("cbid",f),t.__proto__=S,t.CB=function(r,n,e,i){var o;return t.CB.hasOwnProperty(r)?(o=t.CB[r],delete t.CB[r],o.apply({conn:n,cb:i},e)):void t.error("Wrong callback ID: "+r)},e(r.API)&&o(r.API,function(r,e){n.push(e),t.SPI[e]=r}),i(r.send)&&(t.CPI=p(t,n,r.send),t.send=r.send),t}function A(r,t,n){return i(t)?(n=t,t=""):i(r)&&(n=r,t="",r=void 0),i(n)?void this.send.call(r,JSON.stringify({INFO:t,CB:this.createCallback(n)})):void O.warn("reqs.info call without callback for data.")}function B(r,t){function n(r,n){e.CPI=p(e,r,e.send),i(t)&&t(r,n)}var e=this;i(r)&&(t=r,r=void 0),this.send.call(r,JSON.stringify({INFO:"",CB:this.createCallback(n)}))}var S,y=Object.prototype.toString,O=console;return r.exports=v,S={parse:c,err404:l,error:u,info:A,validate:s,createCallback:C,createCBWrapper:h,createWrapper:d,make:B},r.exports})(this.module||{});