this.Reqs=function(r){function t(r){return"[object String]"===L.call(r)}function n(r){return"[object Array]"===L.call(r)}function e(r){return"[object Object]"===L.call(r)}function i(r){return"[object Function]"===L.call(r)}function o(r,t,n){for(var e in r)r.hasOwnProperty(e)&&t.call(n,r[e],e,r)}function a(r){if(void 0!==this.cb){var t=[],n=[];o(this.reqs.server,function(r,n){t.push(n)}),o(this.reqs.client,function(r,t){n.push(t)}),this.cb(t,n)}}function c(r,i){var o,c,s,l,u,f,h=this.server,C=this,d={conn:i,reqs:this};try{o=JSON.parse(r)}catch(p){return void this.error("Not valid JSON.")}if(!this.validate(o))return void this.error("reqs.parse() Not valid object");if(t(o)&&h.hasOwnProperty(o))s=h[o].call(d),void 0!==s&&s===s&&this.send.call(i,JSON.stringify({CALL:o,ARGS:[s]}));else if(e(o))l=[o];else if(!n(o))return void this.err404("reqs.parse() 404 unknown command: "+o.toString());for(u in l){if(u=l[u],void 0!==u.ARGS&&!n(u.ARGS))return void this.err404('Wrong data type in property "ARGS". Data type is: '+L.call(u.ARGS));if(u.hasOwnProperty("CALL")){if(c=u.CALL,void 0===c||!t(c)||!h.hasOwnProperty(c))return void this.err404("Method not found:"+c);if(void 0!==u.CB&&t(u.CB)&&(d.cb=C.createCBWrapper(u.CB,i)),s=h[c].apply(d,u.ARGS),n(s))return void C.send.call(i,JSON.stringify({CALL:c,ARGS:s}))}else{if(u.hasOwnProperty("CALLBACK")){if(f=u.CALLBACK,t(f)){if(void 0!==u.CB&&t(u.CB)){if(s=C.CB(f,i,u.ARGS,C.createCBWrapper(u.CB,i)),n(s))return void C.send.call(i,JSON.stringify({CALLBACK:u.CB,ARGS:s}));return}return void C.CB(f,i,u.ARGS)}return void this.error("Wrong CALLBACK argument type.")}if(!u.hasOwnProperty("INFO"))return void this.err404('Missing root property "CALL" and "CALLBACK".');void 0!==u.CB&&t(u.CB)&&(d.cb=C.createCBWrapper(u.CB,i),a.call(d,u.INFO))}}}function s(r){return!0}function l(r,t){b.warn("Error 404! Resourse not found. Details: "+r),b.warn(t)}function u(r,t){this.send(t,JSON.stringify({ERROR:{MSG:r}}))}function f(){return this._id===Number.MAX_SAFE_INTEGER&&(this._id=1),this._id++}function h(r){var t=this.cbid;return this.CB[t]=r,t.toString()}function C(r,t){var n=this;return function(){var e,o={CALLBACK:r},a=[],c=arguments[arguments.length-1];for(e in arguments)arguments.hasOwnProperty(e)&&a.push(arguments[e]);i(c)&&(o.CB=n.createCallback(c),a=a.slice(0,-1)),a.length>0&&(o.ARGS=a),n.send.call(t,JSON.stringify(o))}}function d(r){if(void 0===r.client){var t=r.send;r.client=function(e,o,a,c){var s={CALL:e};i(c)?s.CB=r.createCallback(c):i(o)?s.CB=r.createCallback(o):i(a)&&(s.CB=r.createCallback(a)),n(a)&&(s.ARGS=a),t.call(o,JSON.stringify(s))}}}function p(r){var t=this;return function(){var n,e={CALL:r},o=[],a=arguments[arguments.length-1];for(n in arguments)arguments.hasOwnProperty(n)&&o.push(arguments[n]);i(a)&&(e.CB=t.createCallback(a),o=o.slice(0,-1)),o.length>0?e.ARGS=o:void 0===e.CB&&(e=r),t.send.call(this,JSON.stringify(e))}}function v(r,t){var n=this;return function(){arguments[arguments.length++]=function(){var t,e={CALL:r},o=[],a=arguments[arguments.length-1];for(t in arguments)arguments.hasOwnProperty(t)&&o.push(arguments[t]);i(a)&&(e.CB=n.createCallback(a),o=o.slice(0,-1)),o.length>0?e.ARGS=o:void 0===e.CB&&(e=r),n.send.call(this,JSON.stringify(e))},t.apply(this,arguments)}}function A(r,t){var i,o,a=0,c=r.client;if(n(t))for(i=t.length,a;i>a;a++)o=t[a],c.hasOwnProperty(o)||(c[o]=p.call(r,o));else if(e(t))for(o in t)t.hasOwnProperty(o)&&c.hasOwnProperty(o)||(c[o]=v.call(r,o,t[o]))}function B(r){r=r||{};var t={server:r.server||{}},n=r.client||[];return t._id=0,t.__defineGetter__("cbid",f),t.__proto__=S,t.CB=function(r,n,e,i){var o;return t.CB.hasOwnProperty(r)?(o=t.CB[r],delete t.CB[r],o.apply({conn:n,cb:i},e)):void t.error("Wrong callback ID: "+r)},e(r.API)&&o(r.API,function(r,e){n.push(e),t.server[e]=r}),i(r.send)&&(t.send=r.send,d(t),A(t,n)),t}function y(r,t,n){return i(t)?(n=t,t=""):i(r)&&(n=r,t="",r=void 0),i(n)?void this.send.call(r,JSON.stringify({INFO:t,CB:this.createCallback(n)})):void b.warn("reqs.info call without callback for data.")}function O(r,t){function n(r,n){A(e,r),i(t)&&t(r,n)}var e=this;i(r)&&(t=r,r=void 0),this.send.call(r,JSON.stringify({INFO:"",CB:this.createCallback(n)}))}var S,L=Object.prototype.toString,b=console;return r.exports=B,S={parse:c,err404:l,error:u,info:y,validate:s,createCallback:h,createCBWrapper:C,clientFunction:p,clientWrapper:v,build:O},r.exports}(this.module||{});