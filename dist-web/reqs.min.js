this.Reqs=function(t){function r(t){return"[object String]"===w.call(t)}function i(t){return"[object Array]"===w.call(t)}function n(t){return"[object Object]"===w.call(t)}function e(t){return"[object Function]"===w.call(t)}function a(t){return w.call(t).slice(8,-1)}function s(t,r,i){for(var n in t)t.hasOwnProperty(n)&&r.call(i,t[n],n,t)}function o(t){if(void 0!==this.cb){var r=[],i=[];s(this.reqs.server,function(t,i){r.push(i)}),s(this.reqs.client,function(t,r){i.push(r)}),this.cb(r,i)}}function c(t,n){var e,s,c,l,u,h,d=this.server,f={conn:n,reqs:this};try{e=JSON.parse(t)}catch(v){return void this.error("Not valid JSON.")}switch(a(e)){case"Object":l=[e];break;case"Array":break;default:return void this.err404("reqs.parse() 404 unknown command: "+e.toString())}for(u in l){if(!this.isValid(e))return void this.invalid(e,n);if(u=l[u],void 0!==u.ARGS&&!i(u.ARGS))return void this.err404('Wrong data type in property "ARGS". Data type is: '+w.call(u.ARGS));if(u.hasOwnProperty("CALL")){if(s=u.CALL,void 0===s||!r(s)||!d.hasOwnProperty(s))return void this.err404("Method not found:"+s);if(void 0!==u.CB&&r(u.CB)&&(f.cb=this.createCBWrapper(u.CB,n)),c=d[s].apply(f,u.ARGS),i(c))return void this.send.call(n,JSON.stringify(this.validate({CALL:s,ARGS:c})))}else{if(u.hasOwnProperty("CALLBACK")){if(h=u.CALLBACK,r(h)){if(void 0!==u.CB&&r(u.CB)){if(c=this.CB(h,n,u.ARGS,this.createCBWrapper(u.CB,n)),i(c))return void this.send.call(n,JSON.stringify(this.validate({CALLBACK:u.CB,ARGS:c})));return}return void this.CB(h,n,u.ARGS)}return void this.error("Wrong CALLBACK argument type.")}if(!u.hasOwnProperty("INFO"))return void this.err404('Missing root property "CALL" and "CALLBACK".',n);void 0!==u.CB&&r(u.CB)&&(f.cb=this.createCBWrapper(u.CB,n),o.call(f,u.INFO))}}}function l(t){return!0}function u(t){return t}function h(t,r){}function d(t,r){R.warn("Error 404! Resourse not found. Details: "+t),R.warn(r)}function f(t,r){this.send.call(r,JSON.stringify(this.validate({ERROR:{MSG:t}})))}function v(){return this._id===Number.MAX_SAFE_INTEGER&&(this._id=1),this._id++}function C(t){var r=this.cbid;return this.CB[r]=t,r.toString()}function p(t,r){var i=this;return function(){var n,a={CALLBACK:t},s=[],o=arguments[arguments.length-1];for(n in arguments)arguments.hasOwnProperty(n)&&s.push(arguments[n]);e(o)&&(a.CB=i.createCallback(o),s=s.slice(0,-1)),s.length>0&&(a.ARGS=s),i.send.call(r,JSON.stringify(i.validate(a)))}}function A(t){if(void 0===t.client){var r=t.send;t.client=function(n,a,s,o){var c={CALL:n};e(o)?c.CB=t.createCallback(o):e(a)?c.CB=t.createCallback(a):e(s)&&(c.CB=t.createCallback(s)),i(s)&&(c.ARGS=s),r.call(a,JSON.stringify(t.validate(c)))}}}function B(t){var r=this;return function(){var i,n={CALL:t},a=[],s=arguments[arguments.length-1];for(i in arguments)arguments.hasOwnProperty(i)&&a.push(arguments[i]);e(s)&&(n.CB=r.createCallback(s),a=a.slice(0,-1)),a.length>0&&(n.ARGS=a),r.send.call(this,JSON.stringify(r.validate(n)))}}function y(t,r){var i=this;return function(){arguments[arguments.length++]=function(){var r,n={CALL:t},a=[],s=arguments[arguments.length-1];for(r in arguments)arguments.hasOwnProperty(r)&&a.push(arguments[r]);e(s)&&(n.CB=i.createCallback(s),a=a.slice(0,-1)),a.length>0&&(n.ARGS=a),i.send.call(this,JSON.stringify(i.validate(n)))},r.apply(this,arguments)}}function O(t,r){var e,a,s=0,o=t.client;if(i(r))for(e=r.length,s;e>s;s++)a=r[s],o.hasOwnProperty(a)||(o[a]=B.call(t,a));else if(n(r))for(a in r)r.hasOwnProperty(a)&&o.hasOwnProperty(a)||(o[a]=y.call(t,a,r[a]))}function S(t){t=t||{};var r={server:t.server||{}},i=t.client||[],o=t.isValid,c=t.validate;switch(r._id=0,r.__defineGetter__("cbid",v),r.__proto__=L,r.CB=function(t,i,n,e){var a;return r.CB.hasOwnProperty(t)?(a=r.CB[t],delete r.CB[t],a.apply({conn:i,cb:e},n)):void r.error("Wrong callback ID: "+t)},n(t.API)&&s(t.API,function(t,n){i.push(n),r.server[n]=t}),e(t.send)&&(r.send=t.send,A(r),O(r,i)),a(c)){case"String":r.validate=function(t){return t.validation=c,t};break;case"Function":r.validate=c}switch(a(o)){case"String":r.isValid=function(t){return t.hasOwnProperty("validation")?t.validation===o:!1};break;case"Function":r.isValid=o}return r}function b(t,r,i){return e(r)?(i=r,r=""):e(t)&&(i=t,r="",t=void 0),e(i)?(this.send.call(t,JSON.stringify(this.validate({INFO:r,CB:this.createCallback(i)}))),this):void R.warn("reqs.info call without callback for data.")}function g(t,r){function i(t,i){O(n,t),e(r)&&r(t,i)}var n=this;return e(t)&&(r=t,t=void 0),this.send.call(t,JSON.stringify(this.validate({INFO:"",CB:this.createCallback(i)}))),this}var L,w=Object.prototype.toString,R=console;return t.exports=S,L={parse:c,err404:d,error:f,info:b,validate:u,isValid:l,invalid:h,createCallback:C,createCBWrapper:p,clientFunction:B,clientWrapper:y,build:g},t.exports}(this.module||{});