function _typeof(a){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(a,b){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a)){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{d||null==h["return"]||h["return"]()}finally{if(e)throw f}}return c}}function _arrayWithHoles(a){if(Array.isArray(a))return a}function isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(a){return!1}}function _construct(){return _construct=isNativeReflectConstruct()?Reflect.construct:function(b,c,d){var e=[null];e.push.apply(e,c);var a=Function.bind.apply(b,e),f=new a;return d&&_setPrototypeOf(f,d.prototype),f},_construct.apply(null,arguments)}function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(a){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}}function _possibleConstructorReturn(a,b){return b&&("object"===_typeof(b)||"function"==typeof b)?b:_assertThisInitialized(a)}function _assertThisInitialized(a){if(void 0===a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function _getPrototypeOf(a){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(a){return a.__proto__||Object.getPrototypeOf(a)},_getPrototypeOf(a)}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function");a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),b&&_setPrototypeOf(a,b)}function _setPrototypeOf(a,b){return _setPrototypeOf=Object.setPrototypeOf||function(a,b){return a.__proto__=b,a},_setPrototypeOf(a,b)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}this.Reqs=function(a){var b=function(){var a=function(){"use strict";function a(b){_classCallCheck(this,a),b&&(this.key=b,this.encode=this.encodeKey,this.decode=this.decodeKey)}return _createClass(a,[{key:"encodeKey",value:function encodeKey(a){return a.key=this.key,JSON.stringify(a)}},{key:"decodeKey",value:function decodeKey(a){var b;if(b=JSON.parse(a),b.key!==this.key)throw new Error("Wrong API Key");return delete b.key,b}}]),a}();return a.category="coders",a.option="coder",a.prototype.encode=JSON.stringify,a.prototype.decode=JSON.parse,a}.call(this);var c,d,e,f,g,h,i,j,k,l,n={}.hasOwnProperty;l={none:0,method:1,callback:2,resolve:3,reject:4,error:5,info:6,0:"none",1:"method",2:"callback",3:"resolve",4:"reject",5:"error",6:"info"},c=function(){var a,b=function(){"use strict";function b(c){_classCallCheck(this,b);var d,e;for(d in this.props=[],c)n.call(c,d)&&(e=c[d],this.props.push(new a(d,e)))}return _createClass(b,[{key:"validate",value:function validate(a,b){var c,d,e,f;for(f=this.props,c=0,d=f.length;c<d;c++)e=f[c],e.validate(a,b);return this}}],[{key:"required",value:function required(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return Object.assign(b,{type:a,required:!0})}}]),b}();return a=function(){"use strict";function a(b,c){_classCallCheck(this,a);var d,e,f,g,h,i,k,l;for(this.name=b,o.isString(c)?g={type:[c]}:(g=c,o.isString(g.type)&&(g.type=[g.type])),this.type=o.null(),i=g.type,(d=0,e=i.length);d<e;d++)l=i[d],this.type[l]=!0;if(this.required=void 0!==g.required&&g.required,g.value&&(this.value=new a(null,g.value)),g.props)for(f in this.props=[],k=g.props,k)n.call(k,f)&&(h=k[f],this.props.push(new a(f,h)))}return _createClass(a,[{key:"validate",value:function validate(a,b,c,d){var e,f,g,h,m,n,p,q,r,s;if(c=this.name||c,this.required||Object.hasOwnProperty.call(b,c)){if(s=b[c],r=o.typeOf(s),d?o.isNumber(c)?d+="[".concat(c,"]"):d+=".".concat(c):d=c,!0!==this.type[r]&&(l=Object.keys(this.type).join(", "),a.throw("Request property type validation fail. Property: '".concat(d,"'. Expected types: '").concat(l,"'. Got type: '").concat(r,"'."))),this.value&&"Array"===r)for(e=g=0,m=s.length;g<m;e=++g)f=s[e],this.value.validate(a,s,e,d);if(this.props&&"Object"===r)for(q=this.props,h=0,n=q.length;h<n;h++)p=q[h],p.validate(a,s,null,d)}return this}}]),a}(),b.Property=a,b}.call(this),j=function a(b){"use strict";_classCallCheck(this,a),this.type=b},h=function(a){"use strict";function b(a,c,d,e){var f;return _classCallCheck(this,b),f=_possibleConstructorReturn(this,_getPrototypeOf(b).call(this,l.method)),f.method=a,c&&(f.id=c),d&&(f.args=d),e&&(f.cbs=e),f}return _inherits(b,a),b}(j),e=function(a){"use strict";function b(a,c,d){var e;return _classCallCheck(this,b),e=_possibleConstructorReturn(this,_getPrototypeOf(b).call(this,l.callback)),e.id=a,c&&(e.args=c),d&&(e.cbs=d),e}return _inherits(b,a),b}(j),k=function(a){"use strict";function b(a,c){var d;return _classCallCheck(this,b),d=_possibleConstructorReturn(this,_getPrototypeOf(b).call(this,l.resolve)),d.id=a,d.resolve=c,d}return _inherits(b,a),b}(j),i=function(a){"use strict";function b(a,c){var d;return _classCallCheck(this,b),d=_possibleConstructorReturn(this,_getPrototypeOf(b).call(this,l.reject)),d.id=a,d.reject=c,d}return _inherits(b,a),b}(j),f=function(a){"use strict";function b(){var a,c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",d=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,e=2<arguments.length?arguments[2]:void 0;return _classCallCheck(this,b),a=_possibleConstructorReturn(this,_getPrototypeOf(b).call(this,l.error)),a.message=c,a.code=d,e&&(a.id=e),a}return _inherits(b,a),b}(j),g=function(a){"use strict";function b(a,c,d){var e;return _classCallCheck(this,b),e=_possibleConstructorReturn(this,_getPrototypeOf(b).call(this,l.info)),e.id=a,c&&(e.events=c),d&&(e.methods=d),e}return _inherits(b,a),b}(j),d=function(){var a=function(){"use strict";function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,a),this.options=b,this.model={request:new c({type:c.required("Number")}),method:new c({method:c.required("String"),id:"String",args:"Array",cbs:"Array"}),callback:new c({id:c.required("String"),args:"Array",cbs:"Array"}),promise:new c({id:c.required("String")}),error:new c({message:c.required("String"),code:"Number",id:"String"}),info:new c({id:c.required("String"),events:"Array",methods:"Array"})}}return _createClass(a,[{key:"throw",value:function _throw(a){throw new Error("Protocol processing error: ".concat(a))}},{key:"parse",value:function parse(a){var b;switch(this.model.request.validate(this,a),a.type){case l.method:this.model.method.validate(this,a),b=new h(a.method,a.id,a.args,a.cbs);break;case l.callback:this.model.callback.validate(this,a),b=new e(a.id,a.args,a.cbs);break;case l.resolve:this.model.promise.validate(this,a),b=new k(a.id,a.resolve);break;case l.reject:this.model.promise.validate(this,a),b=new i(a.id,a.reject);break;case l.error:this.model.error.validate(this,a),b=new f(a.message,a.code,a.id);break;case l.info:this.model.info.validate(this,a),b=new g(a.id,a.events,a.methods);break;default:b=this.throw("Unknown request type: ".concat(a.type));}return b}}]),a}();return a.category="protocols",a.option="coder",a.types=l,a.prototype.types=l,a.Model=c,a.prototype.Method=h,a.Method=h,a.prototype.Callback=e,a.Callback=e,a.prototype.Resolve=k,a.Resolve=k,a.prototype.Reject=i,a.Reject=i,a.prototype.Error=f,a.Error=f,a.prototype.Info=g,a.Info=g,a}.call(this);var o=function(){var a,b,c=function(){"use strict";function a(){_classCallCheck(this,a)}return _createClass(a,null,[{key:"isBoolean",value:function isBoolean(a){return"[object Boolean]"===b.call(a)}},{key:"isString",value:function isString(a){return"[object String]"===b.call(a)}},{key:"isObject",value:function isObject(a){return"[object Object]"===b.call(a)}},{key:"isFunction",value:function isFunction(a){return"[object Function]"===b.call(a)}},{key:"isNumber",value:function isNumber(a){return a===a&&"[object Number]"===b.call(a)}},{key:"typeOf",value:function typeOf(a){return b.call(a).slice(8,-1)}},{key:"null",value:function _null(a){return Object.assign(Object.create(null),a)}}]),a}();return b=Object.prototype.toString,a=Array.isArray,c.isArray=Array.isArray,c}.call(this);var p,n={}.hasOwnProperty;return p=function(){var a,c,e,f=function(){"use strict";function b(){var a=this,c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,b);var d,e,g,h,i,j,k,l;if(this.events=o.null(),this.methods=o.null(),this.isSession=!1,this._callbacks=o.null(),this._id=0,this._promises=o.null(),this._pid=0,c.events)for(h in k=c.events,k)n.call(k,h)&&(g=k[h],this.events[h]=g);if(c.methods&&this.addMethods(c.methods),this.options={methods:c.methods||{},session:c.session},c.send&&(this.send=c.send),c.error&&(this.error=c.error),c.newid&&(this.newid=c.newid),c.newpid&&(this.newpid=c.newpid),e=c.key?[c.key]:[],!c.coder)d=b.coders[b.default.coder];else if(o.isString(c.coder)?d=b.coders[c.coder]:(d=b.coders[c.coder.name||b.default.coder],c.coder.arguments&&(e=c.coder.arguments)),!d)throw new Error("Unknown coder: '".concat(c.coder,"'"));if(this.coder=_construct(d,_toConsumableArray(e)),j=[],!c.protocol)i=b.protocols[b.default.protocol];else if(o.isString(c.protocol)?i=b.protocols[c.protocol]:(i=b.protocols[c.protocol.name||b.default.protocol],c.protocol.arguments&&(j=c.protocol.arguments)),!i)throw new Error("Unknown protocol: '".concat(c.protocol,"'"));this.protocol=_construct(i,_toConsumableArray(j)),c.session?(l=c.session.arguments,o.isString(l)?this.options.session.arguments=[l]:o.isArray(l)&&(this.options.session.arguments=l)):this.options.session={arguments:[]},Object.defineProperty(this,"async",{get:function get(){return a._async},set:function set(b){return a.asyncSet(b)}}),this.async=o.isBoolean(c.mode)?"async"===c.mode:"async"===b.default.mode}return _createClass(b,[{key:"parse",value:function parse(a){var b,c,d,f,g,h;try{b=this.coder.decode(a)}catch(a){return c=a,this.err400("Data processing error: ".concat(c.message,"\n").concat(c.stack))}try{if(o.isArray(b))for(d=0,f=b.length;d<f;d++)g=b[d],h=this.processRequest(g);else h=this.processRequest(b)}catch(a){return c=a,this.err400("Request parsing error: ".concat(c.message,"\n").concat(c.stack))}return h}},{key:"processRequest",value:function processRequest(a){var b,d,f,g,h,i,j,k,l,m,n,o=this;switch(j=this.protocol.parse(a),i=this.protocol,m=i.types,f=j.id,j.type){case m.method:if(g=j.method,n=this.events[g],n){if(b=c(this,j.args,j.cbs),f){try{if(l=n.apply(this,b),l instanceof Promise)return l.then(function(a){return o.request(new i.Resolve(f,a))}).catch(function(a){return o.request(new i.Reject(f,a.toString()))}),l;k=new i.Resolve(f,l)}catch(a){d=a,k=new i.Reject(f,d.toString())}return this.request(k)}return n.apply(this,b)}return this.err404("Method not found: <".concat(g,">."));break;case m.callback:return(n=this._callbacks[f],void 0===n)?this.err404("Wrong callback ID: <".concat(f,">.")):(delete this._callbacks[f],b=c(this,j.args,j.cbs),n.apply(this,b||[]));case m.resolve:return h=this._promises[f],delete this._promises[f],h&&h.resolve?h.resolve.call(this,j.resolve):this.err404("Wrong resolve promise ID: <".concat(f,">."));break;case m.reject:return h=this._promises[f],delete this._promises[f],h&&h.reject?h.reject.call(this,j.reject):this.err404("Wrong reject promise ID: <".concat(f,">."));break;case m.info:if(f)return this.request(new i.Callback(f,[Object.keys(this.methods),Object.keys(this.events)]));break;case m.error:return this.err422("Error request. Code: '".concat(j.code,"'. ").concat(j.message));default:return this.err422("Unknown request type: '".concat(j.type,"'."));}return null}},{key:"request",value:function request(a){return this.send(this.coder.encode(a))}},{key:"err400",value:function err400(a){return this.error(a,400)}},{key:"err404",value:function err404(a){return this.error(a,404)}},{key:"err422",value:function err422(a){return this.error(a,422)}},{key:"error",value:function error(a,b){return console.warn(b,a)}},{key:"sendError",value:function sendError(a,b,c){return this.request(new this.protocol.Error(a,b,c))}},{key:"asyncSet",value:function asyncSet(a){this._async=a,this.methodApply=a?this.methodAsyncApply:this.methodSyncApply}},{key:"coderSet",value:function coderSet(a){return this.coder=b.coders[a]}},{key:"protocolSet",value:function protocolSet(a){return this.protocol=b.protocols[a]}},{key:"use",value:function use(a){for(var b=arguments.length,c=Array(1<b?b-1:0),d=1;d<b;d++)c[d-1]=arguments[d];return this[a.option]=_construct(a,c)}},{key:"createCallback",value:function createCallback(a){var b,c;return b=this,c=function(){return e(b,a,arguments)},c.created=Date.now(),c}},{key:"newid",value:function newid(){return this._id===Number.MAX_SAFE_INTEGER&&(this._id=0),(++this._id).toString()}},{key:"newpid",value:function newpid(){return this._pid===Number.MAX_SAFE_INTEGER&&(this._pid=0),(++this._pid).toString()}},{key:"addCallback",value:function addCallback(a){var b;return b=this.newid(),this._callbacks[b]=a,b}},{key:"method",value:function method(a){for(var b=arguments.length,c=Array(1<b?b-1:0),d=1;d<b;d++)c[d-1]=arguments[d];return this.methodApply(a,c)}},{key:"methodAsync",value:function methodAsync(a){for(var b=arguments.length,c=Array(1<b?b-1:0),d=1;d<b;d++)c[d-1]=arguments[d];return this.methodAsyncApply(a,c)}},{key:"methodSync",value:function methodSync(a){for(var b=arguments.length,c=Array(1<b?b-1:0),d=1;d<b;d++)c[d-1]=arguments[d];return this.methodSyncApply(a,c)}},{key:"methodAsyncApply",value:function methodAsyncApply(b,c){var d,e,f,g,h=this,i=a(this,c),j=_slicedToArray(i,2);return e=j[0],d=j[1],f=this.newpid(),g=new Promise(function(a,b){return h._promises[f]={resolve:a,reject:b}}),this.request(new this.protocol.Method(b,f,e,d)),g}},{key:"methodSyncApply",value:function methodSyncApply(b,c){var d,e,f=a(this,c),g=_slicedToArray(f,2);return e=g[0],d=g[1],this.request(new this.protocol.Method(b,null,e,d))}},{key:"addMethod",value:function addMethod(a){var b;return b=this,this.methods[a]=function(){return b.methodApply(a,arguments)},this}},{key:"createMethod",value:function createMethod(a,b,c,d,e){var f,g,h,i=!(5<arguments.length&&void 0!==arguments[5])||arguments[5];if(f=this,g=this.methods,!(i&&g[a]))return void 0===c?b?g[a]=function(){return f.methodApply(a,b.apply(f,arguments))}:g[a]=function(){return f.methodApply(a,arguments)}:"async"===c?(h=d&&e?b?function(){return f.methodAsyncApply(a,b.apply(f,arguments)).then(d).catch(e)}:function(){return f.methodAsyncApply(a,arguments).then(d).catch(e)}:d?b?function(){return f.methodAsyncApply(a,b.apply(f,arguments)).then(d)}:function(){return f.methodAsyncApply(a,arguments).then(d)}:e?b?function(){return f.methodAsyncApply(a,b.apply(f,arguments)).catch(e)}:function(){return f.methodAsyncApply(a,arguments).catch(e)}:b?function(){return f.methodAsyncApply(a,b.apply(f,arguments))}:function(){return f.methodAsyncApply(a,arguments)},g[a]=h):g[a]=b?function(){return f.methodSyncApply(a,b.apply(f,arguments))}:function(){return f.methodSyncApply(a,arguments)},this}},{key:"addMethods",value:function addMethods(a,b){var c,d,e,f,g,h;if(g=this.methods,o.isArray(a)){for(c=0,d=a.length;c<d;c++)if(f=a[c],o.isString(f)){if(g[f])continue;this.addMethod(f)}else if(o.isObject(f))for(h in f)if(n.call(f,h)){if(e=f[h],g[h])continue;o.isFunction(e)?this.createMethod(h,e,null,null,null,b):this.createMethod(h,e.method,e.mode,e.then,e.catch,b)}}else if(o.isObject(a))for(h in a)if(n.call(a,h)){if(e=a[h],g[h])continue;o.isFunction(e)?this.createMethod(h,e,null,null,null,b):this.createMethod(h,e.method,e.mode,e.then,e.catch,b)}return this}},{key:"info",value:function info(a){var b,c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(!o.isFunction(a))throw new Error("Reqs.info() call without callback for data.");return b=this.addCallback(a),this.request(new this.protocol.Info(b,c.events,c.methods))}},{key:"build",value:function build(a){var b=this;return this.info(function(c,d){if(b.addMethods(d),o.isFunction(a))return a(c,d)}),this}},{key:"new",value:function _new(){var a,b,c,d,e,f;if(this.isSession)throw new Error("<Reqs.Session instance>.new() used for new session creation. Use insted \"<Reqs instance>.new()\".");if(f=Object.create(this),0<arguments.length)for(e=this.options.session.arguments,a=b=0,c=e.length;b<c;a=++b)d=e[a],f[d]=arguments[a];return f.isSession=!0,f.created=Date.now(),f.reqs=this,f._callbacks=o.null(),f._id=0,f._promises=o.null(),f._pid=0,f.methods=o.null(),f.addMethods(this.options.methods),f}}],[{key:"addModule",value:function addModule(a){var b;return b=this[a.category],b||(b=this[a.category]=o.null()),b[a.name]=a,a}}]),b}();return f.default={mode:"sync",coder:"Coder",protocol:"Protocol"},f.protocols=o.null({Protocol:d}),f.coders=o.null({Coder:b}),f.Tools=o,f.Protocol=d,f.Coder=b,f.prototype.send=console.info,a=function(a){var b,c,d,e,f,g,h=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];for(c=[],d=[],(e=f=0,g=h.length);f<g;e=++f)b=h[e],o.isFunction(b)&&(b=a.addCallback(b),d.push(Number.parseInt(e))),c.push(b);return 0===d.length&&(d=null),[c,d]},c=function(a){var b,c,d,e,f=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],g=2<arguments.length?arguments[2]:void 0;if(void 0===g||0===g.length)return f;for(d=0,e=g.length;d<e;d++)c=g[d],b=f[c],f[c]=a.createCallback(b);return f},e=function(b,c,d){var e,f,g=a(b,d),h=_slicedToArray(g,2);return e=h[0],f=h[1],b.request(new b.protocol.Callback(c,e,f))},f}.call(this),a.exports=p,a.exports}(this.module||{});